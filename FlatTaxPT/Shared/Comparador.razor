@inject ICalculadorImpostosProgressivos CalculadorImpostosProgressivos
@inject ICalculadorImpostosFlat CalculadorImpostosFlat

@inject IAnalytics Analytics

<h1>Calculadora de vencimento líquido</h1>

<EditForm Model="@dadosCalculo" OnValidSubmit="@Calcular">
    <DataAnnotationsValidator/>
    <ValidationSummary/>

    <div class="row">
        <fieldset class="col-md-6">
            <legend>Agregado Familiar</legend>
            <div class="mb-3">
                <label for="inputLocalizacao" class="form-label">Localização</label>
                <InputSelect class="form-select" @bind-Value="dadosCalculo.Localizacao" id="inputLocalizacao">
                    <option value="@Localizacao.Continente">Continente</option>
                    <option value="@Localizacao.Acores">Açores</option>
                    <option value="@Localizacao.Madeira">Madeira</option>
                </InputSelect>
            </div>
            <div class="mb-3">
                <label for="inputSituacao" class="form-label">Situação</label>
                <InputSelect class="form-select" @bind-Value="dadosCalculo.Situacao" id="inputSituacao">
                    <option value="@Situacao.NaoCasado">Não Casado</option>
                    <option value="@Situacao.CasadoUnico">Casado, Titular Único</option>
                    <option value="@Situacao.CasadoDois">Casado, Dois Titulares</option>
                </InputSelect>
            </div>
            <div class="mb-3">
                <label for="inputDependentes" class="form-label">Dependentes</label>
                <InputNumber type="number" @bind-Value="dadosCalculo.Dependentes" class="form-control" id="inputDependentes"/>
            </div>
            <div class="mb-3 form-check">
                <InputCheckbox @bind-Value="dadosCalculo.FamiliaMonoparental" class="form-check-input" id="inputMonoparental"/>
                <label for="inputMonoparental" class="form-label">Família Monoparental</label>
            </div>
        </fieldset>
        <fieldset class="col-md-6">
            <legend>Rendimentos</legend>
            <label for="inputVencimento" class="form-label">Vencimento Base</label>
            <InputNumber type="number" @bind-Value="dadosCalculo.VencimentoBase" class="form-control" id="inputVencimento" aria-describedby="ajudaVencimento"/>
            <div id="ajudaVencimento" class="form-text text-muted">Vencimento bruto mensal (vencimento anual / 14 meses)</div>
        </fieldset>
    </div>
    <div class="d-grid gap-2 d-sm-flex justify-content-sm-center p-3">
        <button type="submit" class="btn btn-primary">Calcular</button>
    </div>
</EditForm>

@if (sumarioVisivel)
{
    <table class="table table-bordered">
        <thead class="table-light">
        <tr>
            <th></th>
            <th scope="col" class="text-center">Flat Tax</th>
            <th scope="col" class="text-center">Progressivo</th>
        </tr>
        </thead>
        <tbody>
        <tr>
            <th scope="row">Dedução</th>
            <td class="text-center">@($"{-sumarioImpostosFlat.Deducao:N2}€")</td>
            <td class="text-center">Variável</td>
        </tr>
        <tr>
            <th scope="row">Rendimento tributável</th>
            <td class="text-center">@($"{sumarioImpostosFlat.Tributavel:N2}€")</td>
            <td class="text-center">@($"{sumarioImpostosProgressivos.Tributavel:N2}€")</td>
        </tr>
        <tr>
            <th scope="row">Taxa de IRS</th>
            <td class="text-center">@($"{sumarioImpostosFlat.Taxa:P2}")</td>
            <td class="text-center">@($"{sumarioImpostosProgressivos.Taxa:P2}")</td>
        </tr>
        <tr>
            <th scope="row">Retenção de IRS</th>
            <td class="text-center">@($"{-sumarioImpostosFlat.Retencao:N2}€")</td>
            <td class="text-center">@($"{-sumarioImpostosProgressivos.Retencao:N2}€")</td>
        </tr>
        <tr>
            <th scope="row">Segurança Social</th>
            <td colspan="2" class="text-center">@($"€-{segurancaSocial:N2}")</td>
        </tr>
        <tr>
            <th scope="row">Custo para a empresa</th>
            <td colspan="2" class="text-center">@($"{custoParaEmpresa:N2}€")</td>
        </tr>
        </tbody>
        <tfoot class="table-light">
        <tr class="fw-bold">
            <th scope="row">Vencimento Líquido</th>
            <td class="text-center">@($"{sumarioImpostosFlat.VencimentoLiquido - segurancaSocial:N2}€")</td>
            <td class="text-center">@($"{sumarioImpostosProgressivos.VencimentoLiquido - segurancaSocial:N2}€")</td>
        </tr>
        </tfoot>
    </table>

    <h2 class="alert alert-success text-center">Aumento líquido mensal: @($"{sumarioImpostosFlat.VencimentoLiquido - sumarioImpostosProgressivos.VencimentoLiquido:N2}€")</h2>
}

@if (avisoVisivel)
{
    <h2 class="alert alert-warning text-center">Ainda não é possível efetuar a comparação nos Açores e na Madeia.</h2>
}

@code {
    private readonly DadosCalculo dadosCalculo = new();

    private decimal segurancaSocial;
    private decimal custoParaEmpresa;

    private SumarioImpostos sumarioImpostosFlat = new();
    private SumarioImpostos sumarioImpostosProgressivos = new();

    private bool sumarioVisivel = false;
    private bool avisoVisivel = false;

    private void Calcular()
    {
        Analytics.TrackEvent("comparar", new { vencimento = dadosCalculo.VencimentoBase.ToString() });

        if (dadosCalculo.Localizacao == Localizacao.Continente)
        {
            sumarioVisivel = true;
            avisoVisivel = false;

            sumarioImpostosFlat = CalculadorImpostosFlat.Calcular(dadosCalculo.VencimentoBase, dadosCalculo.Dependentes, dadosCalculo.FamiliaMonoparental);
            sumarioImpostosProgressivos = CalculadorImpostosProgressivos.Calcular(dadosCalculo.VencimentoBase, dadosCalculo.Localizacao, Categoria.Dependente, dadosCalculo.Situacao, false, dadosCalculo.Dependentes);

            segurancaSocial = dadosCalculo.VencimentoBase * dadosCalculo.TaxaSegurancaSocial;
            custoParaEmpresa = dadosCalculo.VencimentoBase + dadosCalculo.VencimentoBase * dadosCalculo.TaxaSegurancaSocialEmpresa;
        }
        else
        {
            sumarioVisivel = false;
            avisoVisivel = true;
        }
    }

}